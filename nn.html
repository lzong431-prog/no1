<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>æé€Ÿèµ›è½¦</title>
<style>
:root{
  --bg:#ffffff; --card:#ffffff; --muted:#555; --text:#222; --acc:#0078d7;
  --ok:#16a34a; --err:#ef4444; --line:#e5e7eb; --shadow:0 1px 2px rgba(0,0,0,.05)
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1200px;margin:20px auto;padding:0 16px}
h1{font-size:22px;margin:0 0 12px}
.badge{display:inline-block;border:1px solid var(--line);border-radius:6px;padding:2px 8px;margin-left:6px;color:var(--muted);background:#f9fafb}
.card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin:12px 0;box-shadow:var(--shadow)}
label{display:block;color:var(--muted);font-size:12px;margin:6px 0 6px}
input,select,button,textarea{width:100%;background:#fff;color:var(--text);border:1px solid #ccc;border-radius:6px;padding:8px 10px;outline:none}
input[type="checkbox"]{width:auto}
button{cursor:pointer}
button.primary{background:var(--acc);color:#fff;font-weight:600;border:none}
.hint{color:var(--muted);font-size:12px}
.toolbar{display:flex;gap:12px;flex-wrap:wrap}
.toolbar>div{flex:1 1 220px;min-width:200px}
.nums span{display:inline-block;min-width:30px;text-align:center;border:1px solid #ddd;border-radius:6px;padding:4px 6px;margin-right:6px;background:#f9fafb}
.grid{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
.grid th,.grid td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
.pill.hit{background:#d1fae5;border:1px solid #16a34a;color:#166534}
.pill.miss{background:#fee2e2;border:1px solid #ef4444;color:#991b1b}
pre.err{white-space:pre-wrap;background:#fef2f2;border:1px solid #fecaca;border-radius:6px;padding:10px;color:#991b1b}
.statebar{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)}
.statebar .dot{width:8px;height:8px;border-radius:50%}
.statebar .ok{background:var(--ok)} .statebar .wait{background:#f59e0b} .statebar .err{background:var(--err)}
header.top{position:sticky;top:0;background:#fff;z-index:20;border-bottom:1px solid var(--line);box-shadow:var(--shadow)}
header.top .bar{max-width:1200px;margin:0 auto;padding:8px 16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
header.top .bar .right{margin-left:auto;display:flex;gap:12px;align-items:center;font-size:13px;color:var(--muted)}
code.inline{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:4px;padding:0 6px}

/* ä¸»ä½“ä¸¤æ ï¼šä¸»åŒºåŸŸ + å³ä¾§æ—¥å¿—ä¾§æ ï¼ˆæ¡Œé¢æ˜¾ç¤ºï¼‰ */
.mainGrid{display:grid;grid-template-columns:1fr 360px;gap:16px}
@media (max-width: 980px){.mainGrid{grid-template-columns:1fr}}
.sidebar{position:sticky;top:64px;align-self:start;height:calc(100vh - 80px);overflow:auto}

/* ç§»åŠ¨ç«¯ï¼šå³ä¸Šè§’â€œæ—¥å¿—æŠ½å±‰â€æŒ‰é’® + æŠ½å±‰å®¹å™¨ */
#openDrawer{display:none}
@media (max-width:980px){#openDrawer{display:inline-block}}
.drawer{
  position:fixed;right:-100%;top:56px;width:92%;max-width:520px;height:calc(100vh - 64px);
  background:#fff;border-left:1px solid var(--line);box-shadow:-4px 0 12px rgba(0,0,0,.06);transition:right .25s ease;z-index:30;display:flex;flex-direction:column
}
.drawer.show{right:0}
.drawer .hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
.drawer .bd{padding:12px;overflow:auto}

/* å½“å¤©å†å²è®°å½•ï¼šå¯æŠ˜å  + é™é«˜æ»šåŠ¨ */
details.hist summary{cursor:pointer;user-select:none;list-style:none;display:flex;align-items:center;gap:8px}
details.hist summary::marker{display:none}
details.hist[open] summary .arrow{transform:rotate(90deg)}
.arrow{transition:transform .15s ease}
.histWrap{max-height:320px;overflow:auto;border:1px solid var(--line);border-radius:8px;padding:6px;margin-top:8px}
.compactRow td{padding-top:6px;padding-bottom:6px}
</style>
</head>
<body>
<header class="top">
  <div class="bar">
    <div class="statebar">
      <div id="stateDot" class="dot wait"></div>
      <div id="stateText">ç­‰å¾…æ“ä½œ</div>
    </div>
    <div class="right">
      <button id="openDrawer" class="primary" style="padding:6px 10px">æŸ¥çœ‹å‘½ä¸­æ—¥å¿—</button>
      <div>ä¸‹æ¬¡è‡ªåŠ¨æ›´æ–°ï¼š<span id="countdown">--</span></div>
      <div>ä¸Šæ¬¡æˆåŠŸï¼š<span id="lastOk">--</span></div>
      <div>é”™è¯¯è®¡æ•°ï¼š<span id="errCnt">0</span></div>
    </div>
  </div>
</header>

<div class="wrap">
  <h1>é©¬ä¸Šå‘è´¢
    <span class="badge">ç¨³ä½</span>
    <span class="badge">èƒ½èµ¢</span>
  </h1>

  <div class="mainGrid">
    <!-- ä¸»åŒºåŸŸ -->
    <section>
      <!-- æ§åˆ¶ + ç»“æœ -->
      <section class="card">
        <div class="toolbar">
          <div>
            <label>æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰</label>
            <input id="date" placeholder="2025-08-21">
          </div>
          <div>
            <label>å–æ•°æ–¹å¼</label>
            <select id="mode">
              <option value="direct">ç›´è¿ API</option>
              <option value="proxy">é€šè¿‡ä»£ç†</option>
              <option value="paste">æ‰‹åŠ¨ç²˜è´´ JSON</option>
            </select>
          </div>
          <div>
            <label>è®¡åˆ’ç æ•°é‡ K</label>
            <input id="k" type="number" value="5" min="1" max="10">
          </div>
        </div>
        <div class="toolbar">
          <div>
            <label>API åŸºç¡€åœ°å€</label>
            <input id="api" value="https://api.api68.com/pks/getPksHistoryList.do">
            <div class="hint">è‡ªåŠ¨æ‹¼æ¥ <code class="inline">?lotCode=10037&date=YYYY-MM-DD</code></div>
          </div>
          <div>
            <label>ä»£ç†å‰ç¼€</label>
            <input id="proxy" placeholder="https://your-proxy.example.com/ æˆ– https://your-proxy.example.com/{url}">
          </div>
          <div>
            <label>åŠè¡°æœŸï¼ˆæœŸæ•°ï¼‰</label>
            <input id="halfLife" type="number" value="60" min="1" max="500">
          </div>
          <div>
            <label>èåˆæƒé‡ Î±</label>
            <input id="alpha" type="number" step="0.05" value="0.7" min="0" max="1">
          </div>
        </div>
        <div class="toolbar">
          <div><label><input id="autoToggle" type="checkbox"> å¯ç”¨è‡ªåŠ¨æ›´æ–°</label></div>
          <div>
            <label>é¢‘ç‡ï¼ˆç§’ï¼‰</label>
            <input id="autoSec" type="number" value="30" min="5" max="180">
          </div>
        </div>
        <div class="toolbar">
          <button id="go" class="primary">ç«‹å³é¢„æµ‹</button>
          <button id="reconcile">æœ€æ–°æœŸå¯¹è´¦</button>
          <button id="clear">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div id="resultCard" style="display:none;margin-top:12px">
          <div><b>ä¸‹ä¸€æœŸé¢„æµ‹ï¼ˆå† å†›ä½ï¼‰</b></div>
          <div id="nextIssue" class="hint"></div>
          <div id="plan" class="nums" style="margin-top:6px"></div>
          <div id="latest" class="hint" style="margin-top:8px"></div>
          <div id="params" class="hint" style="margin-top:8px"></div>
        </div>

        <div id="errCard" style="display:none;margin-top:10px">
          <b>é”™è¯¯ä¿¡æ¯</b>
          <pre class="err" id="errText"></pre>
          <div class="hint">å¸¸è§åŸå› ï¼š1) CORS 2) å½“å¤©æš‚æ— æ•°æ® 3) è¿”å›ç»“æ„ä¸åŒ 4) ä»£ç†æœªæ­£ç¡®è½¬å‘</div>
        </div>

        <!-- ç²˜è´´ JSON -->
        <div id="pasteBox" style="display:none;margin-top:12px">
          <label>æ‰‹åŠ¨ç²˜è´´è¿”å› JSONï¼ˆåŸæ ·ç²˜è´´ï¼‰</label>
          <textarea id="jsonArea" rows="6" placeholder='æŠŠ https://api.api68.com/... è¿”å›çš„å®Œæ•´ JSON ç²˜è¿™é‡Œ'></textarea>
          <div class="hint">åœ¨â€œæ‰‹åŠ¨ç²˜è´´ JSONâ€æ¨¡å¼ä¸‹ï¼ŒæŒ‰é’®ä¼šç›´æ¥ä½¿ç”¨è¿™é‡Œçš„ JSONã€‚</div>
        </div>
      </section>

      <!-- å½“å¤©å†å²è®°å½•ï¼ˆæŠ˜å  + é™é«˜æ»šåŠ¨ + æ¡æ•°é€‰æ‹©ï¼‰ -->
      <section class="card">
        <details class="hist" id="histDetails">
          <summary>
            <span class="arrow">â–¶</span>
            <b>å½“å¤©å†å²è®°å½•</b>
            <span class="hint">ï¼ˆé»˜è®¤æ˜¾ç¤ºæœ€è¿‘ 20 æ¡ï¼Œå±•å¼€å¯æŸ¥çœ‹å…¨éƒ¨ï¼‰</span>
          </summary>
          <div class="toolbar" style="margin-top:10px">
            <div style="max-width:200px">
              <label>æ˜¾ç¤ºæ¡æ•°</label>
              <select id="histCount">
                <option value="20" selected>æœ€è¿‘ 20 æ¡</option>
                <option value="50">æœ€è¿‘ 50 æ¡</option>
                <option value="all">å…¨éƒ¨</option>
              </select>
            </div>
            <div style="max-width:260px">
              <label>æœç´¢ï¼ˆæŒ‰æœŸå·/æ—¶é—´åŒ…å«ï¼‰</label>
              <input id="histSearch" placeholder="ä¾‹å¦‚ 2025-08 æˆ– æœŸå·ç‰‡æ®µ">
            </div>
          </div>
          <div class="histWrap">
            <table class="grid" id="historyTbl">
              <thead><tr><th>æœŸå·</th><th>æ—¶é—´</th><th>å† å†›</th><th>å‰å</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </section>
    </section>

    <!-- å³ä¾§ï¼šå‘½ä¸­æ—¥å¿—ï¼ˆæ¡Œé¢ä¸ºä¾§æ ï¼›ç§»åŠ¨ç«¯æŠ½å±‰ï¼‰ -->
    <aside class="sidebar">
      <section class="card" id="logCardDesktop">
        <b>å‘½ä¸­æ—¥å¿—ï¼ˆlocalStorageï¼‰</b>

<div id="riskBox" class="hint" style="margin-top:6px">
  å½“å‰çŠ¶æ€ï¼š-- ï½œ å½“å‰ä¸‹æ³¨ï¼š-- ï½œ æ€»ç›ˆäºï¼š0 ï½œ æœ€å¤§å›æ’¤ï¼š0 ï½œ è¿æŒ‚ï¼š0
</div>

<div id="logStats" class="hint" style="margin-top:6px">
  æ€»æœŸæ•°ï¼š0 ï½œ æœ€å¤§è¿ä¸­ï¼š0 ï½œ æœ€å¤§è¿æŒ‚ï¼š0
</div>
        <div class="hint" style="margin-top:4px">éšæ—¶å¯è§ï¼›æ‰‹æœºç«¯è¯·ç‚¹å³ä¸Šè§’â€œæŸ¥çœ‹å‘½ä¸­æ—¥å¿—â€ã€‚</div>
        <div style="max-height:calc(100vh - 220px);overflow:auto;margin-top:8px">
          <table class="grid" id="logTbl">
            <thead><tr><th>æ—¶é—´</th><th>é¢„æµ‹æœŸå·</th><th>è®¡åˆ’</th><th>1</th><th>å‘½ä¸­</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="hint">é”®åï¼š<code class="inline">pks_logs_10037</code></div>
      </section>
    </aside>
  </div>
</div>

<!-- ç§»åŠ¨ç«¯æ—¥å¿—æŠ½å±‰ -->
<div class="drawer" id="drawer">
  <div class="hd">
    <b>å‘½ä¸­æ—¥å¿—</b>
    <button id="closeDrawer">å…³é—­</button>
  </div>
  <div class="bd">
    <table class="grid">
      <thead><tr><th>æ—¶é—´</th><th>é¢„æµ‹æœŸå·</th><th>è®¡åˆ’</th><th>å®é™…å† å†›</th><th>å‘½ä¸­</th></tr></thead>
      <tbody id="logTblMobile"></tbody>
    </table>
  </div>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const LOG_KEY='pks_logs_10037';
// ===== é£æ§ä¸çŠ¶æ€é…ç½® =====
const OBSERVE_ROUNDS = 3;          // è§‚å¯Ÿå±€æ•°
const OBSERVE_BET = 5;             // è§‚å¯Ÿå±€æŠ•æ³¨
const BET_SEQ = [5,10,20,40,80,160,320];
const MISS_WARN = 5;               // è¿æŒ‚é¢„è­¦é˜ˆå€¼ï¼ˆå¯æ”¹ï¼‰

// ===== ç›ˆäº + çŠ¶æ€ + å›æ’¤ + è¿æŒ‚ ç»Ÿä¸€è®¡ç®— =====
function calcRiskFromLogs(logs){
  let profit = 0;
  let peakProfit = 0;
  let maxDrawdown = 0;

  let mode = 'observe';            // observe | bet
  let observeLeft = OBSERVE_ROUNDS;
  let betIdx = 0;
  let curBet = OBSERVE_BET;

  let curMiss = 0;
  let warn = false;

  logs
    .filter(l => l.actual !== null)
    .sort((a,b)=>a.ts - b.ts)
    .forEach(l=>{
      const hit = Array.isArray(l.plan) && l.plan.includes(l.actual);

      // ===== è§‚å¯Ÿé˜¶æ®µ =====
      if(mode === 'observe'){
        curBet = OBSERVE_BET;

        if(hit){
          profit += curBet;
          curMiss = 0;
          observeLeft = OBSERVE_ROUNDS;
        }else{
          profit -= curBet;
          curMiss++;
          observeLeft--;
        }

        if(observeLeft <= 0){
          mode = 'bet';
          betIdx = 0;
        }
      }
      // ===== æŠ•æ³¨é˜¶æ®µ =====
      else{
        curBet = BET_SEQ[betIdx];

        if(hit){
          profit += curBet;
          curMiss = 0;
          mode = 'observe';
          observeLeft = OBSERVE_ROUNDS;
          betIdx = 0;
        }else{
          profit -= curBet;
          curMiss++;
          betIdx++;
        }

        if(betIdx >= BET_SEQ.length){
          mode = 'observe';
          observeLeft = OBSERVE_ROUNDS;
          betIdx = 0;
        }
      }

      // ===== æœ€å¤§å›æ’¤ =====
      peakProfit = Math.max(peakProfit, profit);
      maxDrawdown = Math.min(maxDrawdown, profit - peakProfit);

      // ===== è¿æŒ‚é¢„è­¦ =====
      if(curMiss >= MISS_WARN){
        warn = true;
      }
    });

  return {
    profit,
    maxDrawdown,
    mode,
    curBet,
    curMiss,
    warn
  };
}
  let errCount=0, autoTimer=null, cdTimer=null, nextTs=0;
  let lastRecs = []; // ç¼“å­˜å½“å¤©è®°å½•ï¼Œä¾¿äºç­›é€‰/æœç´¢

  // â€”â€” çŠ¶æ€æ  â€”â€”
  function setState(type,text){ $('stateDot').className='dot '+(type||'wait'); $('stateText').textContent=text||'' }
  function setLastOk(ts){ $('lastOk').textContent = ts ? new Date(ts).toLocaleString() : '--' }
  function setErrCnt(n){ $('errCnt').textContent=String(n) }
  function startCountdown(){
    const sec = Math.max(0, Math.ceil((nextTs - Date.now())/1000));
    $('countdown').textContent = (autoTimer? sec : '--');
    if (cdTimer) clearTimeout(cdTimer);
    if (!autoTimer) return;
    cdTimer = setTimeout(startCountdown, 250);
  }

  // â€”â€” é”™è¯¯å±•ç¤º â€”â€”
  function showErr(e){ $('errCard').style.display='block'; $('errText').textContent=String(e?.stack||e) }
  function hideErr(){ $('errCard').style.display='none'; $('errText').textContent='' }

  // â€”â€” æ•°å­¦å·¥å…· â€”â€”
  const zeros10=()=>Array(10).fill(0);
  const normalize10=a=>{const s=a.reduce((x,y)=>x+y,0)||1; return a.map(x=>x/s)};
  const expWeight=(idxFromEnd,halfLife)=>Math.exp(-(Math.log(2)/Math.max(1,halfLife))*idxFromEnd);

  // â€”â€” è§£ææ•°æ® â€”â€”
  function parseRecords(json){
    let arr=[];
    if (Array.isArray(json)) arr=json;
    else if (json?.result){
      if (Array.isArray(json.result)) arr=json.result;
      else if (Array.isArray(json.result.data)) arr=json.result.data;
      else if (Array.isArray(json.result?.data?.list)) arr=json.result.data.list;
    }else if (Array.isArray(json?.data)) arr=json.data;
    arr = (arr||[]).filter(x=> typeof x?.preDrawCode==='string' || Array.isArray(x?.preDrawCode));
    return arr.map(x=>{
      const raw = Array.isArray(x.preDrawCode) ? x.preDrawCode.join(',') : String(x.preDrawCode||'').trim();
      const nums = raw.split(/[ ,|]+/).map(s=>parseInt(s,10)).filter(Number.isFinite);
      return { issue: x.preDrawIssue ?? x.issue ?? '', time: x.preDrawTime ?? x.time ?? '', codes: nums, champ: nums[0] ?? null };
    });
  }

  // â€”â€” ä¸‹ä¸€æœŸæœŸå·ï¼ˆå­—ç¬¦ä¸²å®‰å…¨ï¼‰ â€”â€”
  function nextIssueOf(issue){
    const s = String(issue ?? '');
    if (!s) return '';
    const m = s.match(/(\d+)(?!.*\d)/);
    if (!m) return '';
    const num = m[1];
    const start = (m.index!=null) ? m.index : s.lastIndexOf(num);
    let inc;
    try { inc = (BigInt(num) + 1n).toString().padStart(num.length, '0'); }
    catch { inc = String(parseInt(num,10)+1).padStart(num.length,'0'); }
    return s.slice(0, start) + inc + s.slice(start + num.length);
  }

  // â€”â€” å»ºæ¨¡ â€”â€”
  function freqDist(recs,halfLife){
    const n=recs.length, f=zeros10();
    for(let i=0;i<n;i++){
      const r=recs[n-1-i]; if(!r?.champ) continue;
      const w=expWeight(i,halfLife), idx=r.champ-1;
      if(idx>=0&&idx<10) f[idx]+=w;
    }
    return normalize10(f);
  }
  function markovNext(recs,halfLife){
    const T=Array.from({length:10},()=>zeros10());
    const n=recs.length;
    for(let i=0;i<n-1;i++){
      const a=recs[i].champ, b=recs[i+1].champ; if(!a||!b) continue;
      const w=expWeight((n-2)-i,halfLife);
      const ai=a-1, bi=b-1; if(ai>=0&&ai<10&&bi>=0&&bi<10) T[ai][bi]+=w;
    }
    const latest=recs[n-1]?.champ ?? null;
    const cond = (latest && latest>=1&&latest<=10) ? normalize10(T[latest-1]) : zeros10();
    return cond;
  }
  const combined=(recs,halfLife,alpha)=>{
    const base=freqDist(recs,halfLife);
    const cond=markovNext(recs,halfLife);
    return normalize10(base.map((v,i)=> alpha*v + (1-alpha)*cond[i]));
  }
  const topK=(prob,k)=> prob.map((p,i)=>({num:i+1,p})).sort((a,b)=>b.p-a.p||a.num-b.num).slice(0,k);

  // â€”â€” æ¸²æŸ“ï¼šå†å²ï¼ˆæ”¯æŒæ¡æ•°ä¸æœç´¢è¿‡æ»¤ï¼‰ â€”â€”
  function renderHistoryFiltered(){
    const tbody=$('historyTbl').querySelector('tbody');
    tbody.innerHTML='';
    if(!lastRecs.length) return;
    const q = $('histSearch').value.trim();
    const countSel = $('histCount').value;
    let arr = lastRecs.slice(); // å‡åºå·²åœ¨ compute ä¸­åš
    if(q){
      const s=q.toLowerCase();
      arr = arr.filter(r=> String(r.issue).toLowerCase().includes(s) || String(r.time).toLowerCase().includes(s));
    }
    if(countSel!=='all'){
      const n=parseInt(countSel,10)||20;
      arr = arr.slice(-n);
    }
    arr.slice().reverse().forEach(r=>{
      const tr=document.createElement('tr'); tr.className='compactRow';
      const td1=document.createElement('td'); td1.textContent=String(r.issue||'-');
      const td2=document.createElement('td'); td2.textContent=r.time||'-';
      const td3=document.createElement('td'); td3.textContent=r.champ??'-';
      const td4=document.createElement('td');
      td4.innerHTML=(r.codes||[]).map(n=>`<span style="display:inline-block;min-width:24px;text-align:center;border:1px solid #e5e7eb;border-radius:6px;padding:2px 4px;margin-right:4px;background:#f9fafb">${String(n).padStart(2,'0')}</span>`).join('');
      [td1,td2,td3,td4].forEach(td=>tr.appendChild(td));
      tbody.appendChild(tr);
    });
  }

  // â€”â€” æ¸²æŸ“ï¼šæ—¥å¿—ï¼ˆæ¡Œé¢ä¾§æ  + ç§»åŠ¨æŠ½å±‰åŒä»½æ¸²æŸ“ï¼‰ â€”â€”
  function loadLogs(){try{return JSON.parse(localStorage.getItem(LOG_KEY)||'[]')}catch{return[]}}
  function saveLogs(x){localStorage.setItem(LOG_KEY,JSON.stringify(x))}
// ===== ç»Ÿè®¡ï¼šæ€»æœŸæ•° / æœ€å¤§è¿ä¸­ / æœ€å¤§è¿æŒ‚ï¼ˆåªè¯»æ—¥å¿—ï¼‰=====
function calcStatsFromLogs(logs){
  let total = 0;
  let curHit = 0, maxHit = 0;
  let curMiss = 0, maxMiss = 0;

  logs
    .filter(l => l.actual !== null)
    .sort((a,b)=>a.ts - b.ts)
    .forEach(l=>{
      total++;
      const hit = Array.isArray(l.plan) && l.plan.includes(l.actual);
      if(hit){
        curHit++; curMiss = 0;
        if(curHit > maxHit) maxHit = curHit;
      }else{
        curMiss++; curHit = 0;
        if(curMiss > maxMiss) maxMiss = curMiss;
      }
    });
return { total, maxHit, maxMiss };
}
  function renderLogs(){

    const logs=loadLogs();
    const fill = (tb, rows)=>{
      tb.innerHTML='';
      rows.slice().reverse().forEach(l=>{
        const tr=document.createElement('tr');
        const hit=(l.actual!=null && Array.isArray(l.plan) && l.plan.includes(l.actual));
        tr.innerHTML = `
          <td>${new Date(l.ts).toLocaleString()}</td>
          <td>${String(l.issue)}</td>
          <td>${(l.plan||[]).join(',')}</td>
          <td>${l.actual??'-'}</td>
          <td>${l.actual==null? 'å¾…å¼€å¥–' : `<span class="pill ${hit?'hit':'miss'}">${hit?'å‘½ä¸­':'æœªä¸­'}</span>`}</td>
        `;
        tb.appendChild(tr);
      });
    };
    fill($('logTbl').querySelector('tbody'), logs);
    fill($('logTblMobile'), logs);
// ===== ç»Ÿè®¡å±•ç¤ºï¼ˆè¿½åŠ ï¼Œä¸å½±å“åŸæ¸²æŸ“ï¼‰=====
const stats = calcStatsFromLogs(logs);
const statBox = document.getElementById('logStats');
if(statBox){
  statBox.textContent =
    `æ€»æœŸæ•°ï¼š${stats.total} ï½œ æœ€å¤§è¿ä¸­ï¼š${stats.maxHit} ï½œ æœ€å¤§è¿æŒ‚ï¼š${stats.maxMiss}`;
}

// ===== é£æ§ä¿¡æ¯å±•ç¤º =====
const r = calcRiskFromLogs(logs);
const box = document.getElementById('riskBox');
if(box){
  box.textContent =
    `å½“å‰çŠ¶æ€ï¼š${r.mode === 'observe' ? 'è§‚å¯Ÿ' : 'æŠ•æ³¨'} ï½œ ` +
    `å½“å‰ä¸‹æ³¨ï¼š${r.curBet} ï½œ ` +
    `æ€»ç›ˆäºï¼š${r.profit} ï½œ ` +
    `æœ€å¤§å›æ’¤ï¼š${r.maxDrawdown} ï½œ ` +
    `è¿æŒ‚ï¼š${r.curMiss}` +
    (r.warn ? ' âš ï¸è¿æŒ‚é¢„è­¦' : '');
}

}

  // â€”â€” URL ç»„è£… & è¯·æ±‚ â€”â€”
  const buildTargetURL=()=> $('api').value.trim().replace(/\?+.*/,'') + `?lotCode=10037&date=${encodeURIComponent($('date').value.trim())}`;
  function buildFinalURL(){
    const mode=$('mode').value; const target=buildTargetURL();
    if(mode==='direct') return target;
    if(mode==='proxy'){
      const px=$('proxy').value.trim();
      if(!px) throw new Error('ä»£ç†æ¨¡å¼éœ€å¡«å†™â€œä»£ç†å‰ç¼€â€ã€‚\nç¤ºä¾‹ï¼š1) https://your-proxy.example.com/  2) https://your-proxy.example.com/{url}');
      if(px.includes('{url}')) return px.replace('{url}', encodeURIComponent(target));
      const u=new URL(target);
      return px.replace(/\/+$/,'') + u.pathname + u.search;
    }
    return target;
  }
  async function fetchJSONWithDetails(url){
    try{
      const res=await fetch(url,{credentials:'omit'});
      const ct=res.headers.get('content-type')||''; const text=await res.text();
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}\nURL: ${url}\nå“åº”ä½“: ${text.slice(0,500)}`);
      try{ return JSON.parse(text) }catch(e){ throw new Error(`JSON è§£æå¤±è´¥ï¼š${e.message}\nURL: ${url}\nç‰‡æ®µ: ${text.slice(0,500)}`) }
    }catch(e){
      if(String(e).includes('Failed to fetch')) throw new Error(`ç½‘ç»œ/è·¨åŸŸå¤±è´¥ï¼ˆå¯èƒ½ CORSï¼‰\n${e.message}\nURL: ${url}\nå»ºè®®ï¼šä»£ç†æˆ–ç²˜è´´ JSONã€‚`);
      throw e;
    }
  }

  // â€”â€” ä¸»æµç¨‹ â€”â€”
  function computeAndRender(recs,k,halfLife,alpha){
    if(!recs.length) throw new Error('æ²¡æœ‰è§£æåˆ°å†å²æ•°æ®ï¼ˆæ£€æŸ¥æ—¥æœŸ/è¿”å›ç»“æ„ï¼‰');
    // å‡åºï¼ˆæ—§â†’æ–°ï¼‰
    recs.sort((a,b)=> (a.time||'').localeCompare(b.time||'') || String(a.issue).localeCompare(String(b.issue)));
    lastRecs = recs.slice();
    renderHistoryFiltered();

    const prob=combined(recs,halfLife,alpha);
    const picks=topK(prob,k);
    const latest=recs[recs.length-1];

    let nextIssue = nextIssueOf(latest?.issue);
    if(!nextIssue){
      try{ nextIssue = String(BigInt(String(latest?.issue||'0')) + 1n); }
      catch{ nextIssue = String((parseInt(String(latest?.issue||'0'),10)||0)+1); }
    }

    $('resultCard').style.display='block';
    $('nextIssue').textContent=`é¢„æµ‹æœŸå·ï¼š${String(nextIssue)}ï¼ˆåŸºäºæœ€è¿‘ ${recs.length} æœŸï¼‰`;
    $('plan').innerHTML=picks.map(x=>`<span>${String(x.num).padStart(2,'0')}</span>`).join('');
    $('params').textContent=`K=${k}ï¼ŒåŠè¡°æœŸ=${halfLife}ï¼ŒÎ±=${alpha.toFixed(2)}ï¼›ç»“æœ= Î±Â·é¢‘æ¬¡ + (1-Î±)Â·Markov(æœ€æ–°ä¸€æœŸæ¡ä»¶åˆ†å¸ƒ)`;
    $('latest').textContent= latest ? `æœ€æ–°æœŸï¼š${String(latest.issue)}ï¼Œå† å†›ï¼š${latest.champ}` : '-';

    // è®°å½•æ—¥å¿—ï¼ˆå¾…å¯¹è´¦ï¼‰
    const logs=loadLogs();
    const planNums=picks.map(x=>x.num);
    // ===== æ–°å¢ï¼šè®¡åˆ’å·ç æŒ‰ä»å°åˆ°å¤§æ’åº
    planNums.sort((a, b) => a - b);
    const i=logs.findIndex(x=> String(x.issue) === String(nextIssue) );
    if(i>=0){ logs[i].plan=planNums; logs[i].ts=Date.now(); }
    else{ logs.push({ts:Date.now(),issue:String(nextIssue),plan:planNums,actual:null}); }
    saveLogs(logs); renderLogs();

    return { latest };
  }

  async function pullPredictReconcile(){
    hideErr();
    try{
      setState('wait','æ‹‰å–ä¸­â€¦');
      const date=$('date').value.trim();
      if(!/^\d{4}-\d{2}-\d{2}$/.test(date)) throw new Error('æ—¥æœŸæ ¼å¼åº”ä¸º YYYY-MM-DDï¼Œä¾‹å¦‚ 2025-08-21');
      const k=Math.max(1,Math.min(10, parseInt($('k').value,10)||5));
      const halfLife=Math.max(1, parseInt($('halfLife').value,10)||60);
      const alpha=Math.max(0,Math.min(1, parseFloat($('alpha').value)||0.7));
      const mode=$('mode').value;

      let json=null;
      if(mode==='paste'){
        const txt=$('jsonArea')?.value?.trim?.()||''; if(!txt) throw new Error('è¯·ç²˜è´´ JSON å†å¼€å§‹è®¡ç®—ã€‚');
        try{ json=JSON.parse(txt); }catch(e){ throw new Error('ç²˜è´´çš„ JSON è§£æå¤±è´¥ï¼š'+e.message); }
      }else{
        const finalURL=buildFinalURL();
        json = await fetchJSONWithDetails(finalURL);
      }

      const recs=parseRecords(json).filter(r=>Array.isArray(r.codes)&&r.codes.length>=1);
      const { latest } = computeAndRender(recs,k,halfLife,alpha);

      // å¯¹è´¦
      const logs=loadLogs(); let hit=0,miss=0;
      for(const l of logs){
        if(l.actual==null && String(l.issue)===String(latest.issue)){
          l.actual = latest.champ??null;
          if(l.actual!=null && Array.isArray(l.plan) && l.plan.includes(l.actual)) hit++; else miss++;
        }
      }
      saveLogs(logs); renderLogs();

      setState('ok',`å®Œæˆï¼šğŸ¤´ğŸ»æ­å–œå‘è´¢`);
      setLastOk(Date.now());
      return true;

    }catch(e){
      errCount++; setErrCnt(errCount);
      showErr(e);
      setState('err','å¤±è´¥ï¼šè¯·æŸ¥çœ‹é”™è¯¯ä¿¡æ¯');
      return false;
    }
  }

  // â€”â€” è‡ªåŠ¨æ›´æ–° â€”â€”
  function stopAuto(){ if(autoTimer){ clearInterval(autoTimer); autoTimer=null } if(cdTimer){ clearTimeout(cdTimer); cdTimer=null } $('countdown').textContent='--' }
  function startAuto(){
    stopAuto();
    const sec = Math.max(5, Math.min(180, parseInt($('autoSec').value,10)||30));
    const tick = async ()=>{
      nextTs = Date.now() + sec*1000;
      startCountdown();
      await pullPredictReconcile();
    };
    tick();
    autoTimer = setInterval(tick, sec*1000);
  }

  // â€”â€” äº‹ä»¶ç»‘å®š â€”â€”
  $('go').addEventListener('click', pullPredictReconcile);
  $('reconcile').addEventListener('click', async ()=>{
    hideErr();
    try{
      setState('wait','å¯¹è´¦ä¸­â€¦');
      const mode=$('mode').value; let recs=[];
      if(mode==='paste'){
        const txt=$('jsonArea')?.value?.trim?.()||''; if(!txt) throw new Error('è¯·ç²˜è´´ JSON å†å¯¹è´¦ã€‚');
        recs=parseRecords(JSON.parse(txt));
      }else{
        const finalURL=buildFinalURL();
        const json=await fetchJSONWithDetails(finalURL);
        recs=parseRecords(json);
      }
      if(!recs.length) throw new Error('æ²¡æœ‰è§£æåˆ°å†å²æ•°æ®');
      recs.sort((a,b)=> (a.time||'').localeCompare(b.time||'') || String(a.issue).localeCompare(String(b.issue)));
      const latest=recs[recs.length-1];

      const logs=loadLogs(); let hit=0,miss=0;
      for(const l of logs){
        if(l.actual==null && String(l.issue)===String(latest.issue)){
          l.actual = latest.champ??null;
          if(l.actual!=null && Array.isArray(l.plan) && l.plan.includes(l.actual)) hit++; else miss++;
        }
      }
      saveLogs(logs); renderLogs();
      setState('ok',`å¯¹è´¦å®Œæˆï¼šå‘½ä¸­ ${hit}ï¼Œæœªä¸­ ${miss}`);
      setLastOk(Date.now());
    }catch(e){
      errCount++; setErrCnt(errCount);
      showErr(e);
      setState('err','å¯¹è´¦å¤±è´¥');
    }
  });
  $('clear').addEventListener('click',()=>{
    if(confirm('ç¡®è®¤æ¸…ç©ºæœ¬åœ°å‘½ä¸­æ—¥å¿—ï¼Ÿ')){
      localStorage.removeItem(LOG_KEY); renderLogs();
      setState('ok','å·²æ¸…ç©ºæœ¬åœ°æ—¥å¿—');
    }
  });
  $('autoToggle').addEventListener('change', (e)=>{ if(e.target.checked) startAuto(); else stopAuto() });
  $('autoSec').addEventListener('change', ()=>{ if($('autoToggle').checked) startAuto() });
  $('mode').addEventListener('change', ()=>{ $('pasteBox').style.display = ($('mode').value==='paste') ? 'block' : 'none' });

  // å†å²ç­›é€‰
  $('histCount').addEventListener('change', renderHistoryFiltered);
  $('histSearch').addEventListener('input', renderHistoryFiltered);

  // æŠ˜å é»˜è®¤å…³é—­ï¼Œè‹¥æƒ³é»˜è®¤å±•å¼€å¯åŠ  open å±æ€§
  // æ‰‹æœºæ—¥å¿—æŠ½å±‰
  const drawer=$('drawer');
  $('openDrawer').addEventListener('click', ()=> drawer.classList.add('show'));
  $('closeDrawer').addEventListener('click', ()=> drawer.classList.remove('show'));

  // åˆå§‹åŒ–
  (function init(){
    const d=new Date(); const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0');
    $('date').value=`${yyyy}-${mm}-${dd}`;
    renderLogs();
    setState('wait','ç­‰å¾…æ“ä½œ');
  })();

})();
</script>
</body>
</html>